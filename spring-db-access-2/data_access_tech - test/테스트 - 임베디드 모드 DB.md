테스트 케이스를 실행하기 위해서 별도의 데이터베이스를 설치하고, 운영하는 것은 상당히 번잡한 작업이다.
단순히 테스트를 검증할 용도로만 사용하기 때문에 테스트가 끝나면 데이터베이스의 데이터를 모두 삭제해도 된다.
더 나아가서 테스트가 끝나면 데이터베이스 자체를 제거해도 된다.

**임베디드 모드**
H2 데이터베이스는 자바로 개발되어 있고, JVM안에서 메모리 모드로 동작하는 특별한 기능을 제공한다. 
그래서 애플리케이션을 실행할 때 H2 데이터베이스도 해당 JVM 메모리에 포함해서 함께 실행할 수 있다. DB를 애플리케이션에 내장해서 함께 실행한다고 해서 임베디드 모드(Embedded mode)라 한다.
물론 애플리케이션이 종료되면 임베디드 모드로 동작하는 H2 데이터베이스도 함께 종료되고, 데이터도 모두 사라진다.
쉽게 이야기해서 애플리케이션에서 자바 메모리를 함께 사용하는 라이브러리처럼 동작하는 것이다.

이제 H2 데이터베이스를 임베디드 모드로 사용해보자.

## 임베디드 모드 직접 사용
임베디드 모드를 직접 사용하는 방법은 다음과 같다.

**ItemSerivceApplication - 추가**
```java
package hello.itemservice;  
  
import hello.itemservice.config.*;  
import hello.itemservice.repository.ItemRepository;  
import javax.sql.DataSource;  
import lombok.extern.slf4j.Slf4j;  
import org.springframework.boot.SpringApplication;  
import org.springframework.boot.autoconfigure.SpringBootApplication;  
import org.springframework.context.annotation.Bean;  
import org.springframework.context.annotation.Import;  
import org.springframework.context.annotation.Profile;  
import org.springframework.jdbc.datasource.DriverManagerDataSource;  
  
@Slf4j  
//@Import(MemoryConfig.class)  
//@Import(JdbcTemplateV1Config.class)  
//@Import(JdbcTemplateV2Config.class)  
@Import(JdbcTemplateV3Config.class)  
@SpringBootApplication(scanBasePackages = "hello.itemservice.web")  
public class ItemServiceApplication {  
  
  public static void main(String[] args) {  
   SpringApplication.run(ItemServiceApplication.class, args);  
  }  
  
  @Bean  
  @Profile("local")  
  public TestDataInit testDataInit(ItemRepository itemRepository) {  
   return new TestDataInit(itemRepository);  
  }  
  
  @Bean  
  @Profile("test")  
  public DataSource dataSource() {  
   log.info("메모리 데이터베이스 초기화");  
   DriverManagerDataSource dataSource = new DriverManagerDataSource();  
   dataSource.setDriverClassName("org.h2.Driver");  
   dataSource.setUrl("jdbc:h2:mem:db;DB_CLOSE_DELAY=-1");  
   dataSource.setUsername("sa");  
   dataSource.setPassword("");  
   return dataSource;  
  }  
  
}
```

- `@Profile("test")`  
	- 프로필이 `test`인 경우에만 데이터소스를 스프링 빈으로 등록한다.  
	- 테스트 케이스에서만 이 데이터소스를 스프링 빈으로 등록해서 사용하겠다는 뜻이다.
- `dataSource()`
	- `jdbc:h2:mem:db` 
		- 이 부분이 중요하다. 데이터소스를 만들때 이렇게만 적으면 임베디드 모드(메모리 모드)로 동작하는 H2 데이터베이스를 사용할 수 있다.
	- `DB_CLOSE_DELAY=-1`
		- 임베디드 모드에서는 데이터베이스 커넥션 연결이 모두 끊어지면 데이터베이스도 종료되는데, 그것을 방지하는 설정이다.
		- 이 데이터소스를 사용하면 메모리 DB를 사용할 수 있다.

**실행**
이제 `ItemRepositoryTest` 테스트를 메모리 DB를 통해 실행해보자.
앞에서 설정은 끝났다.
이제 테스트를 실행만 하면 새로 등록한 메모리 DB에 접근하는 데이터소스를 사용하게 된다. 확실하게 하기 위해서 H2 데이터베이스 서버는 잠시 꺼두자

**실행 결과**
```
org.springframework.jdbc.BadSqlGrammarException: PreparedStatementCallback; bad SQL grammar []; nested exception is org.h2.jdbc.JdbcSQLSyntaxErrorException: Table "ITEM" not found; SQL statement:
```
- 실행해보면 다음과 같은 오류를 확인 할 수 있다.
- 참고로 오류는 항상 아래에 있는 오류 정보가 더 근본 원인에 가까운 오류 로그이다.
- `Table "ITEM" not found` 이 부분이 핵심이다.
- 데이터베이스 테이블이 없는 것이다.
- 메모리 DB에는 아직 테이블을 만들지 않았다.

테스트를 실행하기 전에 테이블을 먼저 생성해주어야 한다. 수동으로 할 수도 있지만 스프링 부트는 이 문제를 해결할 아주 편리한 기능을 제공해준다.

**스프링 부트 - 기본 SQL 스크립트를 사용해서 데이터베이스를 초기화하는 기능**
메모리 DB는 애플리케이션이 종료될 때 함께 사라지기 때문에, 애플리케이션 실행 시점에 데이터베이스 테이블도 새로 만들어주어야 한다.
JDBC나 JdbcTemplate를 직접 사용해서 테이블을 생성하는 DDL을 호출해도 되지만, 너무 불편하다.
스프링 부트는 SQL 스크립트를 실행해서 애플리케이션 로딩 시점에 데이터베이스를 초기화하는 기능을 제공한다.

다음 파일을 생성하자.  
위치가 `src/test`이다. (이 부분을 주의하자. 그리고 파일 이름도 맞아야 한다.)

`src/test/resources/schema.sql` 

```sql
drop table if exists item CASCADE;  
create table item  
(  
    id        bigint generated by default as identity,  
    item_name varchar(10),  
    price     integer,  
    quantity  integer,  
    primary key (id)  
);
```

> **참고**
> SQL 스크립트를 사용해서 데이터베이스를 초기화하는 자세한 방법은 다음 스프링 부트 공식 메뉴얼을 참고하자.
> https://docs.spring.io/spring-boot/docs/current/reference/html/howto.html#howto.data-initialization.using-basic-sql-scripts

**실행**  
`ItemRepositoryTest`를 실행해보면 드디어 테스트가 정상 수행되는 것을 확인할 수 있다.

**로그 확인**
기본 SQL 스크립트가 잘 실행되는지 로그로 확인하려면 다음이 추가되었는지 확인하자
`src/test/resources/application.properteis`

```
logging.level.org.springframework.jdbc=debug
```

**SQL 스트립트 로그**
```
o.s.jdbc.datasource.init.ScriptUtils     : Executing SQL script from URL [file:{생략}itemservice-db/out/test/resources/schema.sql]
o.s.jdbc.datasource.init.ScriptUtils     : 0 returned as update count for SQL: drop table if exists item CASCADE
o.s.jdbc.datasource.init.ScriptUtils     : 0 returned as update count for SQL: create table item ( id bigint generated by default as identity, item_name varchar(10), price integer, quantity integer, primary key (id) )
o.s.jdbc.datasource.init.ScriptUtils     : Executed SQL script from URL [file:{생략}/itemservice-db/out/test/resources/schema.sql] in 7 ms.
```

__출처: 인프런 김영한 지식공유자님의 강의 - 스프링 DB 2편__